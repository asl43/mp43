<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Conversor V√≠deo ‚Üí MP3 (Debug Completo)</title>
    <style>
        :root{font-family:Inter, system-ui, Arial; --accent:#0b84ff}
        body{background:#f4f7fb;color:#111;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{width:100%;max-width:1000px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(8,30,60,0.07);padding:20px}
        h1{font-size:20px;margin:0 0 8px}
        p.lead{color:#4b5563;margin:0 0 18px}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 1 240px}
        label{display:block;font-size:13px;margin-bottom:6px;font-weight:500}
        input[type=file]{display:block;width:100%}
        button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px}
        button:disabled{background:#94a3b8;cursor:not-allowed}
        button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefb}
        button.success{background:#059669}
        button.warning{background:#d97706}
        button.error{background:#dc2626}
        pre{background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto;font-size:11px;max-height:200px}
        .log{height:140px;overflow:auto;margin-top:10px;background:#0f1724;color:#d1fae5;padding:10px;border-radius:8px;font-size:11px}
        .log .error{color:#fca5a5}
        .log .success{color:#86efac}
        .log .warning{color:#fcd34d}
        .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .small{font-size:12px}
        .file-list{margin-top:10px}
        .file-item{padding:10px;border-radius:8px;background:#f8fafc;margin-bottom:8px;border:1px solid #e2e8f0}
        .file-meta{font-size:13px;color:#334155;margin-bottom:8px}
        .converted-files{margin-top:15px}
        .converted-item{padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:10px}
        .converted-header{display:flex;justify-content:between;align-items:center;margin-bottom:8px}
        .converted-name{font-weight:500;color:#166534}
        .converted-size{font-size:12px;color:#16a34a}
        .converted-controls{display:flex;gap:6px;flex-wrap:wrap}
        footer{margin-top:12px;font-size:12px;color:#64748b}
        .save-options{background:#fef3c7;padding:12px;border-radius:8px;margin:10px 0}
        .save-options h3{margin:0 0 8px;font-size:14px;color:#92400e}
        .radio-group{display:flex;gap:15px;flex-wrap:wrap}
        .radio-item{display:flex;align-items:center;gap:6px}
        .audio-player{width:100%;margin-top:8px}
        .status-info{background:#eff6ff;padding:10px;border-radius:6px;margin:10px 0;font-size:12px}
        .debug-section{background:#f1f5f9;padding:12px;border-radius:8px;margin:10px 0}
    </style>
</head>
<body>
    <div class="card">
        <h1>üîß Conversor Debug</h1>
        <p class="lead">Vers√£o com debug completo para identificar problemas de convers√£o.</p>

        <div class="debug-section">
            <h3>ü©∫ Status do Sistema</h3>
            <div id="systemStatus">Verificando...</div>
            <div class="controls">
                <button id="testSystemBtn" class="ghost small">üß™ Testar Sistema</button>
                <button id="testFFmpegBtn" class="ghost small">‚öôÔ∏è Testar FFmpeg</button>
                <button id="clearLogsBtn" class="warning small">üóëÔ∏è Limpar Logs</button>
            </div>
        </div>

        <div class="save-options">
            <h3>üìÅ Como salvar arquivos convertidos?</h3>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="saveMode" value="download" checked>
                    <span>Download autom√°tico</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="saveMode" value="browser">
                    <span>Manter no navegador</span>
                </label>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="videoInput">üìπ Selecionar v√≠deo(s)</label>
                <input id="videoInput" type="file" accept="video/*" multiple />

                <div style="margin-top:10px">
                    <label class="small">üéöÔ∏è Qualidade MP3</label>
                    <select id="bitrate">
                        <option value="128">128 kbps</option>
                        <option value="192" selected>192 kbps</option>
                        <option value="320">320 kbps</option>
                    </select>
                </div>

                <div class="controls">
                    <button id="convertBtn">üéµ Converter</button>
                    <button id="convertSingleBtn" class="ghost">üéµ Converter 1¬∫ arquivo</button>
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="col">
                <label>üìä Logs Detalhados</label>
                <div class="log" id="log"></div>

                <label style="margin-top:8px">‚öôÔ∏è Progresso FFmpeg</label>
                <pre id="ffmpegLog">Aguardando...</pre>
            </div>
        </div>

        <div class="converted-files" id="convertedFiles" style="display:none">
            <h3>üéâ Arquivos Convertidos</h3>
            <div id="convertedList"></div>
        </div>

        <footer>
            <strong>üîß Debug:</strong> Esta vers√£o tenta usar CDN automaticamente e mostra todos os erros detalhados.
        </footer>
    </div>

    <script type="module">
        let ffmpeg = null;
        let convertedAudios = [];
        let selectedFiles = [];
        let isConverting = false;

        // Elementos DOM
        const elements = {
            systemStatus: document.getElementById('systemStatus'),
            videoInput: document.getElementById('videoInput'),
            fileList: document.getElementById('fileList'),
            convertBtn: document.getElementById('convertBtn'),
            convertSingleBtn: document.getElementById('convertSingleBtn'),
            testSystemBtn: document.getElementById('testSystemBtn'),
            testFFmpegBtn: document.getElementById('testFFmpegBtn'),
            clearLogsBtn: document.getElementById('clearLogsBtn'),
            log: document.getElementById('log'),
            ffmpegLog: document.getElementById('ffmpegLog'),
            bitrate: document.getElementById('bitrate'),
            convertedFiles: document.getElementById('convertedFiles'),
            convertedList: document.getElementById('convertedList')
        };

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${time}] ${msg}`;
            elements.log.appendChild(div);
            elements.log.scrollTop = elements.log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        }

        function setFFmpegLog(text) {
            elements.ffmpegLog.textContent = text;
        }

        function getSaveMode() {
            return document.querySelector('input[name="saveMode"]:checked').value;
        }

        // Verifica√ß√£o inicial do sistema
        async function checkSystem() {
            try {
                log('üîç Verificando suporte do navegador...');
                
                const checks = {
                    'SharedArrayBuffer': !!window.SharedArrayBuffer,
                    'WebAssembly': !!window.WebAssembly,
                    'Worker': !!window.Worker,
                    'File API': !!window.File,
                    'Blob': !!window.Blob,
                    'URL.createObjectURL': !!window.URL?.createObjectURL
                };

                let statusHtml = '<div style="font-size:12px">';
                for (const [feature, supported] of Object.entries(checks)) {
                    const icon = supported ? '‚úÖ' : '‚ùå';
                    const color = supported ? '#059669' : '#dc2626';
                    statusHtml += `<div style="color:${color}">${icon} ${feature}</div>`;
                    log(`${icon} ${feature}: ${supported ? 'OK' : 'N√ÉO SUPORTADO'}`, supported ? 'success' : 'error');
                }
                statusHtml += '</div>';
                elements.systemStatus.innerHTML = statusHtml;

                if (!window.SharedArrayBuffer) {
                    log('‚ö†Ô∏è SharedArrayBuffer n√£o dispon√≠vel - isso pode causar problemas!', 'warning');
                }

                return Object.values(checks).every(Boolean);
            } catch (err) {
                log(`‚ùå Erro na verifica√ß√£o do sistema: ${err.message}`, 'error');
                return false;
            }
        }

        // Teste do FFmpeg
        async function testFFmpeg() {
            try {
                log('üß™ Testando FFmpeg...');
                setFFmpegLog('Iniciando teste...');
                
                if (!ffmpeg) {
                    await initFFmpeg();
                }

                log('üìù Criando arquivo de teste...');
                await ffmpeg.exec([
                    '-f', 'lavfi',
                    '-i', 'sine=frequency=1000:duration=1',
                    '-acodec', 'mp3',
                    '-b:a', '128k',
                    'test.mp3'
                ]);

                const testData = await ffmpeg.readFile('test.mp3');
                log(`‚úÖ Teste OK! Gerado: ${testData.length} bytes`, 'success');
                
                await ffmpeg.deleteFile('test.mp3');
                setFFmpegLog('‚úÖ FFmpeg funcionando!');
                return true;
                
            } catch (err) {
                log(`‚ùå Teste FFmpeg falhou: ${err.message}`, 'error');
                setFFmpegLog(`‚ùå Erro: ${err.message}`);
                return false;
            }
        }

        // Inicializar FFmpeg
        async function initFFmpeg() {
            if (ffmpeg) return ffmpeg;
            
            try {
                log('üîÑ Inicializando FFmpeg via CDN...');
                
                // Importar dinamicamente
                const { FFmpeg } = await import('https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js');
                const { toBlobURL } = await import('https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js');
                
                ffmpeg = new FFmpeg();
                
                // Configurar logs
                ffmpeg.on('log', ({ type, message }) => {
                    if (message.includes('frame=') || message.includes('time=') || message.includes('size=')) {
                        setFFmpegLog(message.trim());
                    }
                    console.log(`[FFmpeg ${type}] ${message}`);
                });

                ffmpeg.on('progress', (progress) => {
                    if (progress.ratio > 0) {
                        setFFmpegLog(`Progresso: ${(progress.ratio * 100).toFixed(1)}%`);
                    }
                });

                // Carregar FFmpeg
                log('üì¶ Baixando core do FFmpeg...');
                const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm';
                
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });

                log('‚úÖ FFmpeg carregado com sucesso!', 'success');
                return ffmpeg;
                
            } catch (err) {
                log(`‚ùå Falha ao carregar FFmpeg: ${err.message}`, 'error');
                console.error('Erro completo FFmpeg:', err);
                throw err;
            }
        }

        // Sele√ß√£o de arquivos
        elements.videoInput.addEventListener('change', e => {
            selectedFiles = Array.from(e.target.files);
            renderFileList();
            log(`üìÅ Selecionados: ${selectedFiles.length} arquivo(s)`);
        });

        function renderFileList() {
            if (selectedFiles.length === 0) {
                elements.fileList.innerHTML = '<div style="color:#64748b;font-style:italic">Nenhum arquivo</div>';
                return;
            }

            elements.fileList.innerHTML = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <div class="file-meta">
                        <strong>${file.name}</strong><br>
                        <small>üìè ${(file.size/1024/1024).toFixed(2)} MB ‚Ä¢ üé¨ ${file.type}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderConvertedFiles() {
            if (convertedAudios.length === 0) {
                elements.convertedFiles.style.display = 'none';
                return;
            }

            elements.convertedFiles.style.display = 'block';
            elements.convertedList.innerHTML = convertedAudios.map((audio, idx) => `
                <div class="converted-item">
                    <div class="converted-header">
                        <div class="converted-name">üéµ ${audio.name}</div>
                        <div class="converted-size">${(audio.size/1024/1024).toFixed(2)} MB</div>
                    </div>
                    <audio controls class="audio-player">
                        <source src="${audio.url}" type="audio/mpeg">
                    </audio>
                    <div class="converted-controls">
                        <button onclick="downloadAudio(${idx})" class="success small">üíæ Download</button>
                        <button onclick="removeAudio(${idx})" class="warning small">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `).join('');
        }

        // Fun√ß√µes globais
        window.downloadAudio = (idx) => {
            const audio = convertedAudios[idx];
            const a = document.createElement('a');
            a.href = audio.url;
            a.download = audio.name;
            a.click();
            log(`üíæ Download: ${audio.name}`);
        };

        window.removeAudio = (idx) => {
            const audio = convertedAudios[idx];
            URL.revokeObjectURL(audio.url);
            convertedAudios.splice(idx, 1);
            renderConvertedFiles();
            log(`üóëÔ∏è Removido: ${audio.name}`);
        };

        // Convers√£o
        async function convertFiles(files) {
            if (isConverting) {
                log('‚ö†Ô∏è Convers√£o em andamento...', 'warning');
                return;
            }

            try {
                isConverting = true;
                elements.convertBtn.disabled = true;
                elements.convertSingleBtn.disabled = true;
                
                log(`üöÄ Iniciando convers√£o de ${files.length} arquivo(s)...`);
                
                // Garantir que FFmpeg est√° carregado
                if (!ffmpeg) {
                    await initFFmpeg();
                }

                // Importar fetchFile
                const { fetchFile } = await import('https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js');

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    log(`\nüé¨ [${i+1}/${files.length}] Processando: ${file.name}`);
                    
                    try {
                        // Gerar nomes seguros
                        const timestamp = Date.now() + i;
                        const ext = file.name.split('.').pop().toLowerCase();
                        const inputName = `input_${timestamp}.${ext}`;
                        const outputName = `output_${timestamp}.mp3`;

                        log(`üì• Carregando arquivo (${(file.size/1024/1024).toFixed(2)}MB)...`);
                        setFFmpegLog('Carregando arquivo...');
                        
                        const fileData = await fetchFile(file);
                        await ffmpeg.writeFile(inputName, fileData);
                        
                        log(`‚úÖ Arquivo carregado: ${fileData.length} bytes`);
                        log(`üéµ Convertendo para MP3...`);
                        setFFmpegLog('Iniciando convers√£o...');

                        // Comando de convers√£o
                        const bitrate = elements.bitrate.value;
                        const command = [
                            '-i', inputName,
                            '-vn',
                            '-acodec', 'libmp3lame',
                            '-b:a', `${bitrate}k`,
                            '-ar', '44100',
                            '-ac', '2',
                            outputName
                        ];

                        log(`üíª Executando: ffmpeg ${command.join(' ')}`);
                        await ffmpeg.exec(command);

                        // Verificar resultado
                        const outputData = await ffmpeg.readFile(outputName);
                        if (outputData.length === 0) {
                            throw new Error('Arquivo de sa√≠da vazio');
                        }

                        log(`‚úÖ Convers√£o OK: ${outputData.length} bytes`);

                        // Criar blob e salvar
                        const blob = new Blob([outputData], { type: 'audio/mpeg' });
                        const url = URL.createObjectURL(blob);
                        const audioName = file.name.replace(/\.[^/.]+$/, '') + '.mp3';

                        const saveMode = getSaveMode();
                        if (saveMode === 'download') {
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = audioName;
                            a.click();
                            log(`üíæ Download autom√°tico: ${audioName}`, 'success');
                            URL.revokeObjectURL(url);
                        } else {
                            convertedAudios.push({
                                name: audioName,
                                url: url,
                                size: outputData.length,
                                blob: blob
                            });
                            log(`üéµ Adicionado ao player: ${audioName}`, 'success');
                        }

                        // Limpeza
                        await ffmpeg.deleteFile(inputName);
                        await ffmpeg.deleteFile(outputName);

                    } catch (fileErr) {
                        log(`‚ùå Erro no arquivo ${file.name}: ${fileErr.message}`, 'error');
                        console.error('Erro detalhado:', fileErr);
                    }
                }

                renderConvertedFiles();
                log(`üéâ Processo conclu√≠do!`, 'success');
                setFFmpegLog('Conclu√≠do!');

            } catch (err) {
                log(`‚ùå Erro geral: ${err.message}`, 'error');
                console.error('Erro completo:', err);
                setFFmpegLog(`Erro: ${err.message}`);
            } finally {
                isConverting = false;
                elements.convertBtn.disabled = false;
                elements.convertSingleBtn.disabled = false;
            }
        }

        // Event listeners
        elements.testSystemBtn.addEventListener('click', checkSystem);
        elements.testFFmpegBtn.addEventListener('click', testFFmpeg);
        elements.clearLogsBtn.addEventListener('click', () => {
            elements.log.innerHTML = '';
            elements.ffmpegLog.textContent = 'Logs limpos...';
        });

        elements.convertBtn.addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                alert('Selecione pelo menos um v√≠deo!');
                return;
            }
            convertFiles(selectedFiles);
        });

        elements.convertSingleBtn.addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                alert('Selecione um v√≠deo!');
                return;
            }
            convertFiles([selectedFiles[0]]);
        });

        // Inicializa√ß√£o
        log('üöÄ Sistema carregado!');
        checkSystem();
    </script>
</body>
</html>
