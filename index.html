<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Extrator e Conversor de √Åudio</title>
    <style>
        :root{font-family:Inter, system-ui, Arial; --accent:#0b84ff}
        body{background:#f4f7fb;color:#111;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{width:100%;max-width:1000px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(8,30,60,0.07);padding:20px}
        h1{font-size:20px;margin:0 0 8px}
        p.lead{color:#4b5563;margin:0 0 18px}
        .alert{padding:12px;border-radius:8px;margin:15px 0}
        .alert-error{background:#fee2e2;border-left:4px solid #dc2626;color:#991b1b}
        .alert-warning{background:#fef3c7;border-left:4px solid #d97706;color:#92400e}
        .alert-success{background:#dcfce7;border-left:4px solid #16a34a;color:#166534}
        .alert-info{background:#dbeafe;border-left:4px solid #2563eb;color:#1e40af}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 1 240px}
        label{display:block;font-size:13px;margin-bottom:6px;font-weight:500}
        input[type=file]{display:none;}
        button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px}
        button:disabled{background:#94a3b8;cursor:not-allowed}
        button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefb}
        button.success{background:#16a34a}
        button.warning{background:#d97706}
        button.error{background:#dc2626}
        pre{background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto;font-size:11px;max-height:200px}
        .log{height:140px;overflow:auto;margin-top:10px;background:#0f1724;color:#d1fae5;padding:10px;border-radius:8px;font-size:11px}
        .log .error{color:#fca5a5}
        .log .success{color:#86efac}
        .log .warning{color:#fcd34d}
        .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .small{font-size:12px}
        .file-list{margin-top:10px}
        .file-item{padding:10px;border-radius:8px;background:#f8fafc;margin-bottom:8px;border:1px solid #e2e8f0; position: relative;}
        .file-meta{font-size:13px;color:#334155;margin-bottom:8px}
        .converted-files{margin-top:15px}
        .converted-item{padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:10px}
        .converted-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .converted-name{font-weight:500;color:#166534}
        .converted-size{font-size:12px;color:#16a34a}
        .converted-controls{display:flex;gap:6px;flex-wrap:wrap}
        footer{margin-top:12px;font-size:12px;color:#64748b}
        .audio-player{width:100%;margin-top:8px}
        .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin:10px 0}
        .progress-fill{height:100%;background:#16a34a;transition:width 0.3s}
        .method-selector{background:#f0f9ff;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #0ea5e9}
        .method-option{margin:10px 0;padding:10px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer}
        .method-option.selected{border-color:#0b84ff;background:#f0f9ff}
        .method-option h4{margin:0 0 5px;color:#1e40af}
        .method-option p{margin:0;font-size:12px;color:#64748b}
        .drop-area{border:2px dashed #ccc; padding: 20px; text-align: center; font-size: 16px; color: #666; margin-bottom: 15px; border-radius: 8px; cursor: pointer;}
        .drop-area.highlight{border-color: #0b84ff; background-color: #e6eefb;}
    </style>
</head>
<body>
    <div class="card">
        <h1>üéµ Extrator e Conversor de √Åudio</h1>
        <p class="lead">Extraia o √°udio de v√≠deos e arquivos de √°udio diretamente no seu navegador.</p>

        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Limita√ß√£o:</strong> Seu navegador n√£o suporta SharedArrayBuffer. Por isso, a extra√ß√£o de √°udio √© feita usando APIs nativas, e o √°udio de sa√≠da ser√° no formato **WAV**.
        </div>

        <div class="method-selector">
            <h3>üìÅ Op√ß√µes de salvamento:</h3>
            
            <div class="method-option selected" data-save="browser">
                <h4>üéµ Manter no Navegador</h4>
                <p>Arquivos ficam aqui para tocar e baixar depois. N√£o ocupa espa√ßo no disco.</p>
            </div>
            
            <div class="method-option" data-save="download">
                <h4>üíæ Download Autom√°tico</h4>
                <p>Baixa automaticamente para a pasta Downloads ap√≥s a convers√£o.</p>
            </div>
            
            <div class="method-option" data-save="folder">
                <h4>üìÇ Escolher Pasta Externa</h4>
                <p>Salva direto numa pasta espec√≠fica que voc√™ escolher (Chrome/Edge).</p>
            </div>
        </div>

        <div class="method-selector" style="background:#f8fafc;border-color:#64748b">
            <h3>üîß M√©todo de convers√£o:</h3>
            
            <div class="method-option selected" data-method="web-audio">
                <h4>üéµ Web Audio API (Recomendado)</h4>
                <p>Extrai √°udio usando APIs nativas do navegador. Ideal para a maioria dos arquivos de √°udio e v√≠deo.</p>
            </div>
            
            <div class="method-option" data-method="media-recorder">
                <h4>üìπ Media Recorder API</h4>
                <p>Reproduz o v√≠deo silenciosamente e grava o √°udio. Pode ser mais lento, mas funciona como uma alternativa.</p>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>üìπ Selecionar v√≠deo(s) ou √°udio(s)</label>
                <div class="drop-area" id="dropArea">
                    Arraste e solte arquivos aqui, ou clique para selecionar.
                </div>
                <input id="videoInput" type="file" accept="video/*,audio/*" multiple />

                <div style="margin-top:10px">
                    <label class="small">üéöÔ∏è Qualidade de sa√≠da</label>
                    <select id="quality">
                        <option value="0.7">Qualidade Padr√£o</option>
                        <option value="0.9" selected>Alta Qualidade</option>
                        <option value="1.0">M√°xima Qualidade</option>
                    </select>
                </div>

                <div class="controls">
                    <button id="convertBtn">üéµ Converter</button>
                    <button id="chooseFolderBtn" class="ghost">üìÇ Escolher Pasta</button>
                    <button id="clearBtn" class="warning small">üóëÔ∏è Limpar</button>
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="col">
                <label>üìä Status</label>
                <div class="log" id="log"></div>

                <div style="margin-top:10px">
                    <label>‚öôÔ∏è Progresso</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                    <div id="progressText" style="font-size:11px;color:#64748b">Aguardando...</div>
                </div>
            </div>
        </div>

        <div class="converted-files" id="convertedFiles" style="display:none">
            <h3>üéâ Arquivos Processados</h3>
            <div id="convertedList"></div>
        </div>

        <footer>
            <strong>üîç M√©todo ativo:</strong> <span id="currentMethod">Web Audio API</span><br>
            <strong>üíæ Salvamento:</strong> <span id="currentSave">Manter no Navegador</span>
        </footer>
    </div>

    <script>
        let selectedFiles = [];
        let convertedAudios = [];
        let processingQueue = [];
        let isProcessing = false;
        let currentMethod = 'web-audio';
        let saveMode = 'browser';
        let selectedFolder = null;

        const elements = {
            videoInput: document.getElementById('videoInput'),
            fileList: document.getElementById('fileList'),
            convertBtn: document.getElementById('convertBtn'),
            chooseFolderBtn: document.getElementById('chooseFolderBtn'),
            clearBtn: document.getElementById('clearBtn'),
            log: document.getElementById('log'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            quality: document.getElementById('quality'),
            convertedFiles: document.getElementById('convertedFiles'),
            convertedList: document.getElementById('convertedList'),
            currentMethod: document.getElementById('currentMethod'),
            currentSave: document.getElementById('currentSave'),
            dropArea: document.getElementById('dropArea')
        };

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${msg}`;
            elements.log.appendChild(div);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function setProgress(percent, text) {
            elements.progressFill.style.width = `${percent}%`;
            elements.progressText.textContent = text;
        }

        // Sele√ß√£o de m√©todo e modo de salvamento
        document.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                const parent = option.parentElement;
                parent.querySelector('.method-option.selected')?.classList.remove('selected');
                option.classList.add('selected');
                
                if (option.dataset.method) {
                    currentMethod = option.dataset.method;
                    elements.currentMethod.textContent = option.querySelector('h4').textContent;
                    log(`M√©todo alterado: ${option.querySelector('h4').textContent}`);
                }
                
                if (option.dataset.save) {
                    saveMode = option.dataset.save;
                    elements.currentSave.textContent = option.querySelector('h4').textContent;
                    log(`Salvamento alterado: ${option.querySelector('h4').textContent}`);
                    
                    elements.chooseFolderBtn.style.display = saveMode === 'folder' ? 'inline-block' : 'none';
                }
            });
        });

        // Drag-and-Drop
        elements.dropArea.addEventListener('click', () => elements.videoInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, () => elements.dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            elements.dropArea.addEventListener(eventName, () => elements.dropArea.classList.remove('highlight'), false);
        });

        elements.dropArea.addEventListener('drop', e => {
            selectedFiles = Array.from(e.dataTransfer.files);
            renderFileList();
            log(`üìÅ ${selectedFiles.length} arquivo(s) selecionado(s) via arrastar e soltar`);
        }, false);

        // Sele√ß√£o de arquivos
        elements.videoInput.addEventListener('change', e => {
            selectedFiles = Array.from(e.target.files);
            renderFileList();
            log(`üìÅ ${selectedFiles.length} arquivo(s) selecionado(s)`);
        });

        function renderFileList() {
            if (selectedFiles.length === 0) {
                elements.fileList.innerHTML = '<div style="color:#64748b;font-style:italic">Nenhum arquivo</div>';
                return;
            }

            elements.fileList.innerHTML = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <div class="file-meta">
                        <strong>${file.name}</strong><br>
                        <small>üìè ${(file.size/1024/1024).toFixed(2)} MB ‚Ä¢ üé¨ ${file.type}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderConvertedFiles() {
            if (convertedAudios.length === 0) {
                elements.convertedFiles.style.display = 'none';
                return;
            }

            elements.convertedFiles.style.display = 'block';
            elements.convertedList.innerHTML = convertedAudios.map((audio, idx) => `
                <div class="converted-item">
                    <div class="converted-header">
                        <div class="converted-name">üéµ ${audio.name}</div>
                        <div class="converted-size">${(audio.size/1024/1024).toFixed(2)} MB</div>
                    </div>
                    <audio controls class="audio-player">
                        <source src="${audio.url}" type="audio/wav">
                    </audio>
                    <div class="converted-controls">
                        <button onclick="downloadAudio(${idx})" class="success small">üíæ Download</button>
                        <button onclick="saveToFolder(${idx})" class="ghost small" style="display:${selectedFolder ? 'inline-block' : 'none'}">üìÇ Salvar na Pasta</button>
                        <button onclick="removeAudio(${idx})" class="warning small">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `).join('');
        }

        window.downloadAudio = (idx) => {
            const audio = convertedAudios[idx];
            const a = document.createElement('a');
            a.href = audio.url;
            a.download = audio.name;
            a.click();
            log(`üíæ Download: ${audio.name}`);
        };

        window.saveToFolder = async (idx) => {
            if (!selectedFolder) {
                alert('Primeiro escolha uma pasta!');
                return;
            }
            
            try {
                const audio = convertedAudios[idx];
                const fileHandle = await selectedFolder.getFileHandle(audio.name, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(audio.blob);
                await writable.close();
                
                log(`‚úÖ Salvo na pasta: ${audio.name}`, 'success');
            } catch (err) {
                log(`‚ùå Erro ao salvar na pasta: ${err.message}`, 'error');
            }
        };

        window.removeAudio = (idx) => {
            const audio = convertedAudios[idx];
            URL.revokeObjectURL(audio.url);
            convertedAudios.splice(idx, 1);
            renderConvertedFiles();
            log(`üóëÔ∏è Removido: ${audio.name}`);
        };

        // M√©todo 1: Web Audio API
        async function convertWithWebAudio(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                const wav = audioBufferToWav(audioBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                
                return blob;
                
            } catch (err) {
                throw new Error(`Web Audio falhou: ${err.message}`);
            }
        }

        // M√©todo 2: Media Recorder API
        async function convertWithMediaRecorder(file) {
            try {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.muted = true;
                    
                    const stream = video.captureStream();
                    const mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm'
                    });
                    
                    const chunks = [];
                    
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        resolve(blob);
                    };
                    
                    video.onloadedmetadata = () => {
                        video.play();
                        mediaRecorder.start();
                        
                        video.onended = () => {
                            mediaRecorder.stop();
                        };
                    };
                    
                    video.onerror = reject;
                });
                
            } catch (err) {
                throw new Error(`Media Recorder falhou: ${err.message}`);
            }
        }

        // Converter AudioBuffer para WAV
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
            const view = new DataView(arrayBuffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * numberOfChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numberOfChannels * 2, true);
            view.setUint16(32, numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * numberOfChannels * 2, true);
            
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return arrayBuffer;
        }

        async function processNextFileInQueue() {
            if (processingQueue.length === 0) {
                isProcessing = false;
                elements.convertBtn.disabled = false;
                elements.convertBtn.textContent = 'üéµ Converter';
                setProgress(100, 'Conclu√≠do!');
                log('üéâ Processamento finalizado!', 'success');
                renderConvertedFiles();
                return;
            }

            const file = processingQueue.shift();
            const fileIndex = selectedFiles.findIndex(f => f === file);
            const totalFiles = selectedFiles.length;

            setProgress(((totalFiles - processingQueue.length) / totalFiles) * 100, `Processando ${file.name} (${fileIndex + 1} de ${totalFiles})...`);
            log(`üîÑ Processando ${file.name}...`);
            
            try {
                let resultBlob;
                switch (currentMethod) {
                    case 'web-audio':
                        resultBlob = await convertWithWebAudio(file);
                        break;
                    case 'media-recorder':
                        resultBlob = await convertWithMediaRecorder(file);
                        break;
                }
                
                const url = URL.createObjectURL(resultBlob);
                const name = file.name.replace(/\.[^/.]+$/, '') + '.wav';
                
                if (saveMode === 'download') {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    a.click();
                    log(`‚úÖ Download autom√°tico: ${name}`, 'success');
                    URL.revokeObjectURL(url);
                    
                } else if (saveMode === 'folder' && selectedFolder) {
                    try {
                        const fileHandle = await selectedFolder.getFileHandle(name, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(resultBlob);
                        await writable.close();
                        log(`üìÇ Salvo na pasta: ${name}`, 'success');
                        URL.revokeObjectURL(url);
                    } catch (folderErr) {
                        log(`‚ùå Erro ao salvar na pasta, fazendo download: ${folderErr.message}`, 'warning');
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = name;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                } else {
                    convertedAudios.push({
                        name: name,
                        url: url,
                        size: resultBlob.size,
                        blob: resultBlob
                    });
                    log(`üéµ Adicionado ao navegador: ${name}`, 'success');
                }
                
            } catch (err) {
                log(`‚ùå Erro em ${file.name}: ${err.message}`, 'error');
            }

            // Processa o pr√≥ximo arquivo na fila
            processNextFileInQueue();
        }

        // Event listener para iniciar o processamento
        elements.convertBtn.addEventListener('click', () => {
            if (isProcessing) return;
            if (selectedFiles.length === 0) {
                alert('Selecione arquivos primeiro!');
                return;
            }

            isProcessing = true;
            elements.convertBtn.disabled = true;
            elements.convertBtn.textContent = 'Convertendo...';
            processingQueue = [...selectedFiles];
            convertedAudios = [];
            
            processNextFileInQueue();
        });

        // Escolher pasta para salvamento
        elements.chooseFolderBtn.addEventListener('click', async () => {
            try {
                if (!window.showDirectoryPicker) {
                    alert('Seu navegador n√£o suporta sele√ß√£o de pastas. Use Chrome ou Edge mais recente.');
                    return;
                }
                
                selectedFolder = await window.showDirectoryPicker();
                elements.chooseFolderBtn.textContent = `‚úÖ Pasta selecionada`;
                elements.chooseFolderBtn.classList.add('success');
                log(`üìÇ Pasta selecionada: ${selectedFolder.name}`);
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    log(`‚ùå Erro ao escolher pasta: ${err.message}`, 'error');
                }
            }
        });

        elements.clearBtn.addEventListener('click', () => {
            convertedAudios.forEach(audio => URL.revokeObjectURL(audio.url));
            convertedAudios = [];
            selectedFiles = [];
            processingQueue = [];
            elements.videoInput.value = '';
            renderFileList();
            renderConvertedFiles();
            elements.log.innerHTML = '';
            setProgress(0, 'Limpo!');
            log('üßπ Tudo limpo!');
        });

        // Inicializa√ß√£o
        log('üöÄ Extrator de √°udio carregado!');
        log('üí° Este sistema n√£o usa FFmpeg, mas extrai o √°udio com APIs do navegador no formato WAV.');
        
        elements.chooseFolderBtn.style.display = 'none';
    </script>
</body>
</html>
