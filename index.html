<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Conversor V√≠deo ‚Üí MP3 (Sem SharedArrayBuffer)</title>
    <style>
        :root{font-family:Inter, system-ui, Arial; --accent:#0b84ff}
        body{background:#f4f7fb;color:#111;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{width:100%;max-width:1000px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(8,30,60,0.07);padding:20px}
        h1{font-size:20px;margin:0 0 8px}
        p.lead{color:#4b5563;margin:0 0 18px}
        .alert{padding:12px;border-radius:8px;margin:15px 0}
        .alert-error{background:#fee2e2;border-left:4px solid #dc2626;color:#991b1b}
        .alert-warning{background:#fef3c7;border-left:4px solid #d97706;color:#92400e}
        .alert-success{background:#dcfce7;border-left:4px solid #16a34a;color:#166534}
        .alert-info{background:#dbeafe;border-left:4px solid #2563eb;color:#1e40af}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 1 240px}
        label{display:block;font-size:13px;margin-bottom:6px;font-weight:500}
        input[type=file]{display:block;width:100%}
        button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px}
        button:disabled{background:#94a3b8;cursor:not-allowed}
        button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefb}
        button.success{background:#16a34a}
        button.warning{background:#d97706}
        button.error{background:#dc2626}
        pre{background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto;font-size:11px;max-height:200px}
        .log{height:140px;overflow:auto;margin-top:10px;background:#0f1724;color:#d1fae5;padding:10px;border-radius:8px;font-size:11px}
        .log .error{color:#fca5a5}
        .log .success{color:#86efac}
        .log .warning{color:#fcd34d}
        .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .small{font-size:12px}
        .file-list{margin-top:10px}
        .file-item{padding:10px;border-radius:8px;background:#f8fafc;margin-bottom:8px;border:1px solid #e2e8f0}
        .file-meta{font-size:13px;color:#334155;margin-bottom:8px}
        .converted-files{margin-top:15px}
        .converted-item{padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:10px}
        .converted-header{display:flex;justify-content:between;align-items:center;margin-bottom:8px}
        .converted-name{font-weight:500;color:#166534}
        .converted-size{font-size:12px;color:#16a34a}
        .converted-controls{display:flex;gap:6px;flex-wrap:wrap}
        footer{margin-top:12px;font-size:12px;color:#64748b}
        .audio-player{width:100%;margin-top:8px}
        .progress-bar{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin:10px 0}
        .progress-fill{height:100%;background:#16a34a;transition:width 0.3s}
        .method-selector{background:#f0f9ff;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #0ea5e9}
        .method-option{margin:10px 0;padding:10px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer}
        .method-option.selected{border-color:#0b84ff;background:#f0f9ff}
        .method-option h4{margin:0 0 5px;color:#1e40af}
        .method-option p{margin:0;font-size:12px;color:#64748b}
    </style>
</head>
<body>
    <div class="card">
        <h1>üéµ Conversor MP3 (Alternativo)</h1>
        <p class="lead">Como SharedArrayBuffer n√£o est√° dispon√≠vel, vamos usar m√©todos alternativos para extrair √°udio.</p>

        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Limita√ß√£o:</strong> Seu navegador n√£o suporta SharedArrayBuffer, ent√£o o FFmpeg.wasm n√£o pode funcionar. 
            Vamos usar alternativas que funcionam no seu ambiente.
        </div>

        <div class="method-selector">
            <h3>üîß Escolha o m√©todo de convers√£o:</h3>
            
            <div class="method-option selected" data-method="web-audio">
                <h4>üéµ Web Audio API (Recomendado)</h4>
                <p>Extrai √°udio usando APIs nativas do navegador. Funciona com arquivos de √°udio j√° existentes.</p>
            </div>
            
            <div class="method-option" data-method="media-recorder">
                <h4>üìπ Media Recorder API</h4>
                <p>Reproduz o v√≠deo silenciosamente e grava o √°udio. Pode ser mais lento mas funciona.</p>
            </div>
            
            <div class="method-option" data-method="extract-audio">
                <h4>üîß Extra√ß√£o Simples</h4>
                <p>Tenta extrair stream de √°udio diretamente do arquivo de v√≠deo (limitado).</p>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="videoInput">üìπ Selecionar v√≠deo(s)</label>
                <input id="videoInput" type="file" accept="video/*,audio/*" multiple />

                <div style="margin-top:10px">
                    <label class="small">üéöÔ∏è Qualidade de sa√≠da</label>
                    <select id="quality">
                        <option value="0.7">Boa qualidade</option>
                        <option value="0.9" selected>Alta qualidade</option>
                        <option value="1.0">M√°xima qualidade</option>
                    </select>
                </div>

                <div class="controls">
                    <button id="convertBtn">üéµ Converter</button>
                    <button id="testBtn" class="ghost">üß™ Testar M√©todo</button>
                    <button id="clearBtn" class="warning small">üóëÔ∏è Limpar</button>
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="col">
                <label>üìä Status</label>
                <div class="log" id="log"></div>

                <div style="margin-top:10px">
                    <label>‚öôÔ∏è Progresso</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                    <div id="progressText" style="font-size:11px;color:#64748b">Aguardando...</div>
                </div>
            </div>
        </div>

        <div class="converted-files" id="convertedFiles" style="display:none">
            <h3>üéâ Arquivos Processados</h3>
            <div id="convertedList"></div>
        </div>

        <div class="alert alert-info" style="margin-top:20px">
            <strong>üí° Dica:</strong> Estes m√©todos alternativos podem n√£o funcionar t√£o bem quanto o FFmpeg, 
            mas devem conseguir extrair √°udio b√°sico de v√≠deos simples. Para convers√µes profissionais, 
            use software desktop como Audacity ou VLC.
        </div>

        <footer>
            <strong>üîç M√©todo ativo:</strong> <span id="currentMethod">Web Audio API</span>
        </footer>
    </div>

    <script>
        let selectedFiles = [];
        let convertedAudios = [];
        let isProcessing = false;
        let currentMethod = 'web-audio';

        const elements = {
            videoInput: document.getElementById('videoInput'),
            fileList: document.getElementById('fileList'),
            convertBtn: document.getElementById('convertBtn'),
            testBtn: document.getElementById('testBtn'),
            clearBtn: document.getElementById('clearBtn'),
            log: document.getElementById('log'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            quality: document.getElementById('quality'),
            convertedFiles: document.getElementById('convertedFiles'),
            convertedList: document.getElementById('convertedList'),
            currentMethod: document.getElementById('currentMethod')
        };

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${msg}`;
            elements.log.appendChild(div);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function setProgress(percent, text) {
            elements.progressFill.style.width = `${percent}%`;
            elements.progressText.textContent = text;
        }

        // Sele√ß√£o de m√©todo
        document.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelector('.method-option.selected')?.classList.remove('selected');
                option.classList.add('selected');
                currentMethod = option.dataset.method;
                elements.currentMethod.textContent = option.querySelector('h4').textContent;
                log(`M√©todo alterado: ${option.querySelector('h4').textContent}`);
            });
        });

        // Sele√ß√£o de arquivos
        elements.videoInput.addEventListener('change', e => {
            selectedFiles = Array.from(e.target.files);
            renderFileList();
            log(`üìÅ ${selectedFiles.length} arquivo(s) selecionado(s)`);
        });

        function renderFileList() {
            if (selectedFiles.length === 0) {
                elements.fileList.innerHTML = '<div style="color:#64748b;font-style:italic">Nenhum arquivo</div>';
                return;
            }

            elements.fileList.innerHTML = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <div class="file-meta">
                        <strong>${file.name}</strong><br>
                        <small>üìè ${(file.size/1024/1024).toFixed(2)} MB ‚Ä¢ üé¨ ${file.type}</small>
                    </div>
                </div>
            `).join('');
        }

        function renderConvertedFiles() {
            if (convertedAudios.length === 0) {
                elements.convertedFiles.style.display = 'none';
                return;
            }

            elements.convertedFiles.style.display = 'block';
            elements.convertedList.innerHTML = convertedAudios.map((audio, idx) => `
                <div class="converted-item">
                    <div class="converted-header">
                        <div class="converted-name">üéµ ${audio.name}</div>
                        <div class="converted-size">${(audio.size/1024/1024).toFixed(2)} MB</div>
                    </div>
                    <audio controls class="audio-player">
                        <source src="${audio.url}" type="audio/mpeg">
                    </audio>
                    <div class="converted-controls">
                        <button onclick="downloadAudio(${idx})" class="success small">üíæ Download</button>
                        <button onclick="removeAudio(${idx})" class="warning small">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `).join('');
        }

        window.downloadAudio = (idx) => {
            const audio = convertedAudios[idx];
            const a = document.createElement('a');
            a.href = audio.url;
            a.download = audio.name;
            a.click();
            log(`üíæ Download: ${audio.name}`);
        };

        window.removeAudio = (idx) => {
            const audio = convertedAudios[idx];
            URL.revokeObjectURL(audio.url);
            convertedAudios.splice(idx, 1);
            renderConvertedFiles();
            log(`üóëÔ∏è Removido: ${audio.name}`);
        };

        // M√©todo 1: Web Audio API
        async function convertWithWebAudio(file) {
            try {
                log(`üéµ Usando Web Audio API para ${file.name}`);
                
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                log('üîÑ Decodificando √°udio...');
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                log('üìä Criando arquivo WAV...');
                const wav = audioBufferToWav(audioBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                
                return blob;
                
            } catch (err) {
                throw new Error(`Web Audio falhou: ${err.message}`);
            }
        }

        // M√©todo 2: Media Recorder API
        async function convertWithMediaRecorder(file) {
            try {
                log(`üìπ Usando Media Recorder para ${file.name}`);
                
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.muted = true;
                    
                    const stream = video.captureStream();
                    const mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm'
                    });
                    
                    const chunks = [];
                    
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        resolve(blob);
                    };
                    
                    video.onloadedmetadata = () => {
                        video.play();
                        mediaRecorder.start();
                        
                        video.onended = () => {
                            mediaRecorder.stop();
                        };
                    };
                    
                    video.onerror = reject;
                });
                
            } catch (err) {
                throw new Error(`Media Recorder falhou: ${err.message}`);
            }
        }

        // M√©todo 3: Extra√ß√£o simples
        async function convertWithExtraction(file) {
            try {
                log(`üîß Tentando extra√ß√£o simples de ${file.name}`);
                
                // Para arquivos que j√° s√£o √°udio, apenas converter formato
                if (file.type.startsWith('audio/')) {
                    return file;
                }
                
                throw new Error('Extra√ß√£o simples n√£o suporta este formato');
                
            } catch (err) {
                throw new Error(`Extra√ß√£o falhou: ${err.message}`);
            }
        }

        // Converter AudioBuffer para WAV
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * numberOfChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numberOfChannels * 2, true);
            view.setUint16(32, numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * numberOfChannels * 2, true);
            
            // Audio data
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return arrayBuffer;
        }

        // Processamento principal
        async function processFiles(files) {
            if (isProcessing) return;
            
            try {
                isProcessing = true;
                elements.convertBtn.disabled = true;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    setProgress((i / files.length) * 100, `Processando ${file.name}...`);
                    
                    try {
                        let resultBlob;
                        
                        switch (currentMethod) {
                            case 'web-audio':
                                resultBlob = await convertWithWebAudio(file);
                                break;
                            case 'media-recorder':
                                resultBlob = await convertWithMediaRecorder(file);
                                break;
                            case 'extract-audio':
                                resultBlob = await convertWithExtraction(file);
                                break;
                        }
                        
                        const url = URL.createObjectURL(resultBlob);
                        const name = file.name.replace(/\.[^/.]+$/, '') + '.wav';
                        
                        convertedAudios.push({
                            name: name,
                            url: url,
                            size: resultBlob.size,
                            blob: resultBlob
                        });
                        
                        log(`‚úÖ Processado: ${name}`, 'success');
                        
                    } catch (err) {
                        log(`‚ùå Erro em ${file.name}: ${err.message}`, 'error');
                    }
                }
                
                renderConvertedFiles();
                setProgress(100, 'Conclu√≠do!');
                log('üéâ Processamento finalizado!', 'success');
                
            } catch (err) {
                log(`‚ùå Erro geral: ${err.message}`, 'error');
            } finally {
                isProcessing = false;
                elements.convertBtn.disabled = false;
            }
        }

        // Event listeners
        elements.convertBtn.addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                alert('Selecione arquivos primeiro!');
                return;
            }
            processFiles(selectedFiles);
        });

        elements.testBtn.addEventListener('click', async () => {
            log('üß™ Testando m√©todo atual...');
            
            if (selectedFiles.length === 0) {
                alert('Selecione um arquivo para testar!');
                return;
            }
            
            await processFiles([selectedFiles[0]]);
        });

        elements.clearBtn.addEventListener('click', () => {
            convertedAudios.forEach(audio => URL.revokeObjectURL(audio.url));
            convertedAudios = [];
            selectedFiles = [];
            renderFileList();
            renderConvertedFiles();
            elements.log.innerHTML = '';
            setProgress(0, 'Limpo!');
            log('üßπ Tudo limpo!');
        });

        // Inicializa√ß√£o
        log('üöÄ Sistema alternativo carregado!');
        log('üí° Este sistema n√£o usa FFmpeg, mas tenta extrair √°udio com APIs do navegador');
    </script>
</body>
</html>
