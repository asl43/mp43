<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Conversor V√≠deo ‚Üí MP3 (Controle de Salvamento)</title>
    <style>
        :root{font-family:Inter, system-ui, Arial; --accent:#0b84ff}
        body{background:#f4f7fb;color:#111;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{width:100%;max-width:1000px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(8,30,60,0.07);padding:20px}
        h1{font-size:20px;margin:0 0 8px}
        p.lead{color:#4b5563;margin:0 0 18px}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 1 240px}
        label{display:block;font-size:13px;margin-bottom:6px;font-weight:500}
        input[type=file]{display:block;width:100%}
        button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px}
        button:disabled{background:#94a3b8;cursor:not-allowed}
        button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefb}
        button.success{background:#059669}
        button.warning{background:#d97706}
        pre{background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto;font-size:12px}
        .log{height:120px;overflow:auto;margin-top:10px;background:#0f1724;color:#d1fae5;padding:10px;border-radius:8px;font-size:12px}
        .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .small{font-size:12px}
        .file-list{margin-top:10px}
        .file-item{padding:10px;border-radius:8px;background:#f8fafc;margin-bottom:8px;border:1px solid #e2e8f0}
        .file-meta{font-size:13px;color:#334155;margin-bottom:8px}
        .converted-files{margin-top:15px}
        .converted-item{padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:10px}
        .converted-header{display:flex;justify-content:between;align-items:center;margin-bottom:8px}
        .converted-name{font-weight:500;color:#166534}
        .converted-size{font-size:12px;color:#16a34a}
        .converted-controls{display:flex;gap:6px;flex-wrap:wrap}
        footer{margin-top:12px;font-size:12px;color:#64748b}
        .save-options{background:#fef3c7;padding:12px;border-radius:8px;margin:10px 0}
        .save-options h3{margin:0 0 8px;font-size:14px;color:#92400e}
        .radio-group{display:flex;gap:15px;flex-wrap:wrap}
        .radio-item{display:flex;align-items:center;gap:6px}
        .audio-player{width:100%;margin-top:8px}
    </style>
</head>
<body>
    <div class="card">
        <h1>üéµ Conversor V√≠deo ‚Üí MP3</h1>
        <p class="lead">Converta v√≠deos para MP3 e escolha como salvar os arquivos convertidos.</p>

        <div class="save-options">
            <h3>üìÅ Como deseja salvar os arquivos convertidos?</h3>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="saveMode" value="download" checked>
                    <span>Download autom√°tico (pasta Downloads)</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="saveMode" value="choosefolder">
                    <span>Escolher pasta espec√≠fica</span>
                </label>
                <label class="radio-item">
                    <input type="radio" name="saveMode" value="browser">
                    <span>Manter no navegador (tocar aqui)</span>
                </label>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label for="videoInput">üìπ Selecionar v√≠deo(s)</label>
                <input id="videoInput" type="file" accept="video/*" multiple />

                <div style="margin-top:10px">
                    <label class="small">üéöÔ∏è Qualidade MP3 (kbps)</label>
                    <select id="bitrate">
                        <option value="128">128 kbps (boa qualidade)</option>
                        <option value="192" selected>192 kbps (alta qualidade)</option>
                        <option value="256">256 kbps (muito alta)</option>
                        <option value="320">320 kbps (m√°xima)</option>
                    </select>
                </div>

                <div class="controls">
                    <button id="convertBtn">üéµ Converter para MP3</button>
                    <button id="chooseFolderBtn" class="ghost small">üìÅ Escolher Pasta</button>
                    <button id="clearAllBtn" class="warning small">üóëÔ∏è Limpar Tudo</button>
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="col">
                <label>üìä Status</label>
                <div class="log" id="log">Pronto para converter...</div>

                <label style="margin-top:8px">‚öôÔ∏è Progresso</label>
                <pre id="progress">Aguardando...</pre>
            </div>
        </div>

        <div class="converted-files" id="convertedFiles" style="display:none">
            <h3>üéâ Arquivos Convertidos</h3>
            <div id="convertedList"></div>
        </div>

        <footer>
            <strong>üí° Dicas:</strong>
            ‚Ä¢ "Escolher pasta" funciona no Chrome/Edge
            ‚Ä¢ "Manter no navegador" permite tocar os arquivos aqui mesmo
            ‚Ä¢ Arquivos ficam salvos at√© voc√™ fechar a aba
        </footer>
    </div>

    <script type="module">
        // Importa a biblioteca FFmpeg da sua pasta local 'ffmpeg'
        import { FFmpeg } from './ffmpeg/ffmpeg.js';
        import { fetchFile } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

        let ffmpeg = null;
        let selectedFolder = null;
        let convertedAudios = []; // Array para guardar os √°udios convertidos

        // Elementos DOM
        const videoInput = document.getElementById('videoInput');
        const fileList = document.getElementById('fileList');
        const convertBtn = document.getElementById('convertBtn');
        const chooseFolderBtn = document.getElementById('chooseFolderBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const logEl = document.getElementById('log');
        const progressEl = document.getElementById('progress');
        const bitrateSelect = document.getElementById('bitrate');
        const convertedFiles = document.getElementById('convertedFiles');
        const convertedList = document.getElementById('convertedList');
        const saveModeRadios = document.querySelectorAll('input[name="saveMode"]');

        let selectedFiles = [];
        let isConverting = false;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setProgress(text) {
            progressEl.textContent = text;
        }

        function getSaveMode() {
            return document.querySelector('input[name="saveMode"]:checked').value;
        }

        // Escolher pasta para salvar
        chooseFolderBtn.addEventListener('click', async () => {
            try {
                if (!window.showDirectoryPicker) {
                    alert('Seu navegador n√£o suporta sele√ß√£o de pastas. Use Chrome ou Edge.');
                    return;
                }
                selectedFolder = await window.showDirectoryPicker();
                log(`üìÅ Pasta selecionada: ${selectedFolder.name}`);
                chooseFolderBtn.textContent = `‚úÖ ${selectedFolder.name}`;
            } catch (err) {
                log(`‚ùå Erro ao escolher pasta: ${err.message}`);
            }
        });

        // Limpar tudo
        clearAllBtn.addEventListener('click', () => {
            selectedFiles = [];
            convertedAudios = [];
            renderFileList();
            renderConvertedFiles();
            logEl.innerHTML = '';
            log('üßπ Tudo limpo!');
        });

        // Sele√ß√£o de arquivos
        videoInput.addEventListener('change', e => {
            selectedFiles = Array.from(e.target.files);
            renderFileList();
            log(`üìÅ ${selectedFiles.length} arquivo(s) selecionado(s)`);
        });

        function renderFileList() {
            fileList.innerHTML = '';
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '<div style="color:#64748b;font-style:italic">Nenhum arquivo selecionado</div>';
                return;
            }

            selectedFiles.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-meta">
                        <strong>${file.name}</strong><br>
                        <small>üìè ${(file.size/1024/1024).toFixed(2)} MB ‚Ä¢ üé¨ ${file.type || 'Tipo desconhecido'}</small>
                    </div>
                    <button onclick="convertSingle(${idx})" class="ghost small">üéµ Converter este</button>
                `;
                fileList.appendChild(item);
            });
        }

        function renderConvertedFiles() {
            if (convertedAudios.length === 0) {
                convertedFiles.style.display = 'none';
                return;
            }

            convertedFiles.style.display = 'block';
            convertedList.innerHTML = '';

            convertedAudios.forEach((audio, idx) => {
                const item = document.createElement('div');
                item.className = 'converted-item';
                item.innerHTML = `
                    <div class="converted-header">
                        <div class="converted-name">üéµ ${audio.name}</div>
                        <div class="converted-size">${(audio.size/1024/1024).toFixed(2)} MB</div>
                    </div>
                    <audio controls class="audio-player">
                        <source src="${audio.url}" type="audio/mpeg">
                        Seu navegador n√£o suporta o elemento de √°udio.
                    </audio>
                    <div class="converted-controls">
                        <button onclick="downloadAudio(${idx})" class="success small">üíæ Download</button>
                        <button onclick="saveToFolder(${idx})" class="ghost small">üìÅ Salvar na Pasta</button>
                        <button onclick="removeAudio(${idx})" class="warning small">üóëÔ∏è Remover</button>
                    </div>
                `;
                convertedList.appendChild(item);
            });
        }

        // Fun√ß√µes globais para os bot√µes
        window.convertSingle = async (idx) => {
            await convertFiles([selectedFiles[idx]]);
        };

        window.downloadAudio = (idx) => {
            const audio = convertedAudios[idx];
            const a = document.createElement('a');
            a.href = audio.url;
            a.download = audio.name;
            a.click();
            log(`üíæ Download iniciado: ${audio.name}`);
        };

        window.saveToFolder = async (idx) => {
            if (!selectedFolder) {
                alert('Primeiro escolha uma pasta!');
                return;
            }
            
            try {
                const audio = convertedAudios[idx];
                const response = await fetch(audio.url);
                const blob = await response.blob();
                
                const fileHandle = await selectedFolder.getFileHandle(audio.name, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                log(`‚úÖ Salvo na pasta: ${audio.name}`);
            } catch (err) {
                log(`‚ùå Erro ao salvar: ${err.message}`);
            }
        };

        window.removeAudio = (idx) => {
            const audio = convertedAudios[idx];
            URL.revokeObjectURL(audio.url);
            convertedAudios.splice(idx, 1);
            renderConvertedFiles();
            log(`üóëÔ∏è Removido: ${audio.name}`);
        };

        async function initFFmpeg() {
            if (ffmpeg) return;
            
            try {
                log('üîÑ Carregando FFmpeg...');
                ffmpeg = new FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('frame=') || message.includes('time=')) {
                        setProgress(message.trim());
                    }
                });

                // AQUI EST√Å A ALTERA√á√ÉO: APONTA PARA A PASTA LOCAL
                const baseURL = './ffmpeg/';
                await ffmpeg.load({
                    coreURL: `${baseURL}ffmpeg-core.js`,
                    wasmURL: `${baseURL}ffmpeg-core.wasm`,
                });
                
                log('‚úÖ FFmpeg carregado!');
            } catch (err) {
                log(`‚ùå Erro ao carregar FFmpeg: ${err.message}`);
                throw err;
            }
        }

        // Converter arquivos
        convertBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                alert('Selecione pelo menos um v√≠deo!');
                return;
            }
            await convertFiles(selectedFiles);
        });

        async function convertFiles(files) {
            if (isConverting) {
                log('‚ö†Ô∏è Convers√£o j√° em andamento...');
                return;
            }

            try {
                isConverting = true;
                convertBtn.disabled = true;
                
                await initFFmpeg();
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    log(`üé¨ [${i+1}/${files.length}] Convertendo: ${file.name}`);
                    
                    const inputName = `input_${Date.now()}.${file.name.split('.').pop()}`;
                    const outputName = `output_${Date.now()}.mp3`;
                    
                    // Carregar arquivo
                    setProgress('üì• Carregando arquivo...');
                    await ffmpeg.writeFile(inputName, await fetchFile(file));
                    
                    // Converter
                    const bitrate = bitrateSelect.value;
                    setProgress('üéµ Convertendo para MP3...');
                    
                    await ffmpeg.exec([
                        '-i', inputName,
                        '-vn',
                        '-acodec', 'mp3',
                        '-b:a', `${bitrate}k`,
                        '-ar', '44100',
                        outputName
                    ]);

                    // Ler resultado
                    const data = await ffmpeg.readFile(outputName);
                    const blob = new Blob([data], { type: 'audio/mpeg' });
                    const url = URL.createObjectURL(blob);
                    
                    const audioName = file.name.replace(/\.[^/.]+$/, '') + '.mp3';
                    const audioObj = {
                        name: audioName,
                        url: url,
                        size: data.length,
                        blob: blob
                    };

                    // Salvar conforme o modo escolhido
                    const saveMode = getSaveMode();
                    
                    if (saveMode === 'download') {
                        // Download autom√°tico
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = audioName;
                        a.click();
                        log(`üíæ Download autom√°tico: ${audioName}`);
                        URL.revokeObjectURL(url); // Limpar URL ap√≥s download
                    } else if (saveMode === 'choosefolder' && selectedFolder) {
                        // Salvar na pasta escolhida
                        const fileHandle = await selectedFolder.getFileHandle(audioName, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        log(`üìÅ Salvo na pasta: ${audioName}`);
                        URL.revokeObjectURL(url);
                    } else {
                        // Manter no navegador
                        convertedAudios.push(audioObj);
                        log(`üéµ Adicionado ao player: ${audioName}`);
                    }

                    // Limpeza
                    await ffmpeg.deleteFile(inputName);
                    await ffmpeg.deleteFile(outputName);
                }
                
                renderConvertedFiles();
                log(`üéâ Convers√£o conclu√≠da!`);
                setProgress('‚úÖ Pronto!');
                
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`);
                setProgress('‚ùå Erro na convers√£o');
            } finally {
                isConverting = false;
                convertBtn.disabled = false;
            }
        }

        // Log inicial
        log('üöÄ Conversor carregado e pronto!');
    </script>
</body>
</html>
